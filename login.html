<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Yarım Kalan Hikayeler — Giriş</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <link rel="stylesheet" href="style.css?v=4">
</head>
<body>
  <div class="wrap">
    <h1>Yarım Kalan Hikayeler — Giriş</h1>
    <div class="card">
      <div class="filters" id="filters"></div>

      <div class="row">
        <div>
          <label for="timeFilter">Karşılaşılan zaman aralığı:</label>
          <select id="timeFilter">
            <option value="all">Tümü</option>
            <option value="morning">Sabah (05:00–10:59)</option>
            <option value="noon">Öğlen (11:00–14:59)</option>
            <option value="evening">Akşamüstü (15:00–18:59)</option>
            <option value="night">Gece (19:00–23:59)</option>
          </select>
        </div>
        <div></div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label for="userSelect">Giriş için kullanıcı seç:</label>
          <select id="userSelect">
            <option value="">Seçiniz…</option>
          </select>
          <div id="count" class="muted"></div>
          <div id="timesPreview" class="muted"></div>
        </div>
        <div>
          <button id="loginBtn" type="button">Giriş Yap</button>
        </div>
      </div>

      <div class="muted">İpucu: Klavyeden <strong>Enter</strong> ile giriş yapabilirsin.</div>
    </div>
  </div>

  <script>
    (function () {
      var allUsers = [];
      var currentFilter = 'Tümü';
      var currentTime = 'all';

      function uniq(arr){ var m={}; arr.forEach(function(x){m[x]=true}); return Object.keys(m); }
      function parseHM(s){ var p=s.split(':'); return (+p[0])*60 + (+p[1]); }
      function overlapsAny(ranges, startM, endM){
        if (!Array.isArray(ranges)) return false;
        for (var i=0;i<ranges.length;i++){
          var sp = ranges[i].split('-'); if (sp.length!==2) continue;
          var a = parseHM(sp[0].trim()), b = parseHM(sp[1].trim());
          if (Math.max(a,startM) <= Math.min(b,endM)) return true;
        }
        return false;
      }
      function timeWindowMinutes(key){
        if (key==='morning')  return [5*60, 10*60+59];
        if (key==='noon')     return [11*60,14*60+59];
        if (key==='evening')  return [15*60,18*60+59];
        if (key==='night')    return [19*60,23*60+59];
        return null;
      }

      function buildFilters(){
        var filtersEl = document.getElementById('filters');
        filtersEl.innerHTML = '';
        var tags = ['Tümü'];
        allUsers.forEach(function(u){ (u.ulassim||[]).forEach(function(t){ tags.push(t); }); });
        uniq(tags).forEach(function(t){
          var chip = document.createElement('button');
          chip.type='button';
          chip.className='chip'+(t===currentFilter?' active':'');
          chip.textContent=t;
          chip.onclick=function(){ currentFilter=t; buildFilters(); fillSelect(); };
          filtersEl.appendChild(chip);
        });
      }

      function matchesTime(u){
        if (currentTime==='all') return true;
        var win = timeWindowMinutes(currentTime);
        if (!win) return true;
        return overlapsAny(u.karsilasma, win[0], win[1]);
      }

      function renderTimesPreview(id){
        var box = document.getElementById('timesPreview');
        if (!id) { box.textContent = ''; return; }
        var u = allUsers.find(function(x){ return String(x.id)===String(id); });
        if (!u || !u.karsilasma || !u.karsilasma.length) { box.textContent = ''; return; }
        box.textContent = 'Karşılaşma saatleri: ' + u.karsilasma.join(' • ');
      }

      function fillSelect(){
        var sel = document.getElementById('userSelect');
        var savedId = localStorage.getItem('ykh_selected_user_id');

        var filtered = allUsers.filter(function(u){
          var passTransport = (currentFilter==='Tümü') ? true :
             Array.isArray(u.ulassim) && u.ulassim.indexOf(currentFilter)!==-1;
          var passTime = matchesTime(u);
          return passTransport && passTime;
        });

        sel.innerHTML = '';
        var def = document.createElement('option'); def.value=''; def.textContent='Seçiniz…';
        sel.appendChild(def);

        filtered.forEach(function(u){
          var opt=document.createElement('option');
          opt.value=String(u.id);
          opt.textContent=u.ad+' ('+u.yas+')';
          sel.appendChild(opt);
        });

        if (savedId && filtered.some(function(u){return String(u.id)===String(savedId)})){
          sel.value = savedId;
        }

        var fName = (currentFilter!=='Tümü' ? ' • Ulaşım: '+currentFilter : '');
        var tMap = {all:'', morning:' • Zaman: Sabah', noon:' • Zaman: Öğlen', evening:' • Zaman: Akşamüstü', night:' • Zaman: Gece'};
        document.getElementById('count').textContent = filtered.length + ' kişi bulundu' + fName + (tMap[currentTime]||'');

        renderTimesPreview(sel.value);
      }

      function loadUsers() {
        fetch('data/users.json?v=' + Date.now())
          .then(function(res){ if(!res.ok) throw new Error('users.json bulunamadı'); return res.json(); })
          .then(function(users){ allUsers=users; buildFilters(); fillSelect(); })
          .catch(function(e){ console.error(e); alert('Kullanıcılar yüklenemedi: '+e.message); });
      }

      function goProfile() {
        var id = document.getElementById('userSelect').value;
        if (!id) return alert('Lütfen bir kullanıcı seç.');
        localStorage.setItem('ykh_selected_user_id', id);
        window.location.href = 'profil.html?id=' + encodeURIComponent(id);
      }

      document.addEventListener('DOMContentLoaded', function(){
        document.getElementById('loginBtn').onclick = goProfile;
        document.getElementById('userSelect').addEventListener('change', function(e){
          renderTimesPreview(e.target.value);
        });
        document.getElementById('userSelect').addEventListener('keydown', function(e){
          if (e.key==='Enter') goProfile();
        });
        document.getElementById('timeFilter').onchange = function(){
          currentTime = this.value; fillSelect();
        };
        loadUsers();
      });
    })();
  </script>
</body>
</html>
