<!doctype html>
<meta charset="utf-8">
<title>Yarım Kalan Hikayeler</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preload" href="data/users.json" as="fetch" crossorigin="anonymous">
<style>
  :root{
    --bg:#fafafa; --card:#fff; --line:#eee; --text:#111; --muted:#666; --link:#0a66ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:10;background:#fffbd8eb;backdrop-filter:saturate(160%) blur(4px);
    border-bottom:1px solid var(--line);padding:10px 14px}
  .row{display:flex;gap:10px;align-items:center;max-width:1000px;margin:0 auto}
  .brand{font-weight:800;letter-spacing:.2px}
  .sp{flex:1}
  .search{display:flex;gap:8px;align-items:center;width:100%}
  .search input{flex:1;padding:11px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px;background:#fff}
  .search button{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
  .badge{font-size:12px;color:#444;background:#f2f2f2;border:1px solid #e8e8e8;border-radius:999px;padding:4px 8px}

  .wrap{max-width:1000px;margin:14px auto;padding:0 14px}
  .grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(190px,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;
    box-shadow:0 1px 3px rgba(0,0,0,.04);display:flex;flex-direction:column}
  .thumb{aspect-ratio:1/1;background:#f1f1f1}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .p{padding:10px 12px}
  .name{font-weight:700}
  .tags{color:var(--muted);font-size:12px;margin-top:4px;min-height:16px}
  a.card{color:inherit;text-decoration:none}
  .toolbar{display:flex;align-items:center;gap:10px;margin:8px 0 14px}
  .err,.empty{margin:12px 0;padding:12px;border-radius:10px}
  .err{background:#f8d7da;border:1px solid #f5c2c7;color:#842029}
  .empty{background:#eef6ff;border:1px solid #d6e6ff;color:#0b3d91}
  .toplinks a{color:var(--link);text-decoration:none;margin-left:10px;font-size:14px}
  .sr-only{position:absolute;left:-9999px}
</style>

<header>
  <div class="row">
    <div class="brand">Yarım Kalan Hikayeler</div>
    <div class="sp"></div>
    <div class="toplinks">
      <a href="login.html">Giriş</a>
    </div>
  </div>
  <div class="row" style="margin-top:8px">
    <form class="search" id="searchForm" role="search" aria-label="Kullanıcı ara">
      <input id="q" type="search" placeholder="İsim veya etiket ara (ör. kitap, metrobüs)…" autocomplete="off" aria-describedby="count">
      <button type="button" id="clear" title="Temizle">Temizle</button>
      <span class="badge" id="count" aria-live="polite">0 kişi</span>
    </form>
  </div>
</header>

<div class="wrap">
  <div id="err" class="err" style="display:none"></div>
  <div id="empty" class="empty" style="display:none">Sonuç bulunamadı. Farklı bir arama deneyin.</div>
  <div id="grid" class="grid" aria-live="polite"></div>
  <noscript>
    <div class="err">Bu sayfa JavaScript ile çalışır. Lütfen tarayıcınızda JavaScript'i etkinleştirin.</div>
  </noscript>
</div>

<script>
const grid  = document.getElementById("grid");
const err   = document.getElementById("err");
const empty = document.getElementById("empty");
const q     = document.getElementById("q");
const clearBtn = document.getElementById("clear");
const count = document.getElementById("count");

let USERS = [];
let FILTERED = [];

function setError(msg){
  err.style.display = "block";
  err.textContent = msg;
}
function clearError(){ err.style.display="none"; err.textContent=""; }

function render(list){
  grid.innerHTML = "";
  list.forEach(u=>{
    const a = document.createElement("a");
    a.className = "card";
    a.href = "profil.html?id=" + encodeURIComponent(u.id);
    a.innerHTML = `
      <div class="thumb">
        <img loading="lazy" src="assets/${u.photo}?v=${Date.now()}" alt="${u.name}">
      </div>
      <div class="p">
        <div class="name">${u.name}</div>
        <div class="tags">${(u.tags||[]).join(" • ")}</div>
      </div>
    `;
    grid.appendChild(a);
  });
  count.textContent = list.length + " kişi";
  empty.style.display = list.length ? "none" : "block";
}

function normalize(t){ return String(t||"").toLocaleLowerCase("tr"); }

function applyFilter(){
  const term = normalize(q.value).trim();
  if(!term){ FILTERED = USERS.slice(); render(FILTERED); return; }
  FILTERED = USERS.filter(u=>{
    const hay = [u.name, ...(u.tags||[])].map(normalize).join(" | ");
    return hay.includes(term) || hay.split(/\s+/).some(w => w.startsWith(term));
  });
  render(FILTERED);
}

// debounce
let t; q.addEventListener("input", ()=>{ clearTimeout(t); t=setTimeout(applyFilter, 120); });
clearBtn.addEventListener("click", ()=>{ q.value=""; applyFilter(); q.focus(); });

// URL'den ?q= ön-yükleme
const urlQ = new URLSearchParams(location.search).get("q");
if(urlQ){ q.value = urlQ; }

fetch("data/users.json?v="+Date.now())
  .then(r=>{ if(!r.ok) throw new Error("users.json yüklenemedi (HTTP "+r.status+")"); return r.json(); })
  .then(list=>{
    if(!Array.isArray(list)) throw new Error("users.json bir liste ([]) değil.");
    USERS = list;
    applyFilter();
  })
  .catch(e=> setError("Hata: " + e.message));
</script>
