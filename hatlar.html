<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hatlar | Yarım Kalan Hikayeler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f7f7f9;
      color: #222;
    }

    a {
      color: inherit;
    }

    header {
      margin-bottom: 16px;
      text-align: left;
    }

    header a.home-link {
      font-size: 14px;
      text-decoration: none;
      color: #555;
    }

    h1 {
      font-size: 22px;
      margin: 8px 0 4px;
      text-align: left;
    }

    p.intro {
      font-size: 14px;
      margin: 0 0 8px;
      color: #555;
    }

    #example {
      font-size: 13px;
      margin-bottom: 12px;
      color: #777;
    }

    #selectedHatLabel {
      font-size: 13px;
      margin-bottom: 6px;
      color: #444;
    }

    #backAll {
      display: none;
      margin-bottom: 16px;
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
      color: #0072ff;
      padding: 0;
    }

    #hatsSection {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .hat-btn {
      border: 1px solid #ccc;
      background: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
    }

    .hat-btn:hover {
      background: #eee;
    }

    #usersSection {
      margin-top: 8px;
    }

    .user-card {
      display: block;
      padding: 12px 14px;
      margin-bottom: 12px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e2e2e2;
      text-decoration: none;
      color: inherit;
      box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    }

    .user-card:hover {
      background: #f2f6ff;
      border-color: #c7d7ff;
    }

    .user-card h3 {
      margin: 0 0 4px;
      font-size: 16px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge-premium {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #ffdf80;
    }

    .user-route {
      font-size: 13px;
      color: #666;
      margin: 0 0 4px;
    }

    .user-bio {
      font-size: 13px;
      margin: 0 0 4px;
    }

    .user-meta {
      font-size: 12px;
      color: #888;
      margin: 0;
    }

    @media (min-width: 768px) {
      body {
        max-width: 720px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <header>
    <a href="index.html" class="home-link">Yarım Kalan Hikayeler</a>
    <h1>Hattını Seç</h1>
    <p class="intro">
      Metrobüs / metro / otobüs hattını seç, o hatta gördüğün insanları bul.
    </p>
    <div id="example">Örn: 34AS, M4, Marmaray.</div>
  </header>

  <div id="selectedHatLabel"></div>
  <button id="backAll">← Tüm hatlar</button>

  <section id="hatsSection">
    <!-- Hat butonları buraya gelecek -->
  </section>

  <section id="usersSection">
    <!-- Kullanıcı kartları buraya gelecek -->
  </section>

  <script>
    // Çok basit ve hatasız JS, fetch + then zinciri
    const hatsSection = document.getElementById("hatsSection");
    const usersSection = document.getElementById("usersSection");
    const backAll = document.getElementById("backAll");
    const selectedHatLabel = document.getElementById("selectedHatLabel");

    // URL parametrelerinden hat bilgisi al
    const urlParams = new URLSearchParams(location.search);
    const selectedHat = (urlParams.get("hat") || "").trim();

    // users.json'u çek
    fetch("data/users.json?cachebuster=" + Date.now())
      .then(function (res) {
        if (!res.ok) {
          throw new Error("users.json yüklenemedi: " + res.status);
        }
        return res.json();
      })
      .then(function (json) {
        const users = Array.isArray(json.users) ? json.users : [];

        // Hat sayıları
        const hatCounts = {};
        users.forEach(function (u) {
          (u.lines || []).forEach(function (h) {
            hatCounts[h] = (hatCounts[h] || 0) + 1;
          });
        });

        // Hat butonlarını çiz
        const hatNames = Object.keys(hatCounts).sort(function (a, b) {
          return a.localeCompare(b, "tr");
        });

        hatsSection.innerHTML = hatNames
          .map(function (hat) {
            return (
              '<button class="hat-btn" data-hat="' +
              hat +
              '">' +
              hat +
              " (" +
              hatCounts[hat] +
              ")</button>"
            );
          })
          .join("");

        // Butonlara tıklama
        var buttons = hatsSection.querySelectorAll(".hat-btn");
        buttons.forEach(function (btn) {
          btn.addEventListener("click", function () {
            var hat = btn.getAttribute("data-hat");
            var newUrl = new URL(location.href);
            newUrl.searchParams.set("hat", hat);
            location.href = newUrl.toString();
          });
        });

        // Kullanıcıları çiz
        renderUsers(users, selectedHat);
      })
      .catch(function (e) {
        usersSection.innerHTML =
          '<p style="color:#c00;">Hata: ' + e.message + "</p>";
      });

    // Seçili hatta göre kullanıcıları çiz
    function renderUsers(users, hat) {
      if (!hat) {
        selectedHatLabel.textContent = "";
        backAll.style.display = "none";
        usersSection.innerHTML = "<p>Bir hat seçerek başla.</p>";
        return;
      }

      selectedHatLabel.textContent = "Seçilen hat: " + hat;
      backAll.style.display = "inline-block";

      const filtered = users.filter(function (u) {
        return (u.lines || []).indexOf(hat) !== -1;
      });

      if (!filtered.length) {
        usersSection.innerHTML = "<p>Bu hatta henüz kimse yok.</p>";
        return;
      }

      const cards = filtered
        .map(function (u) {
          const premiumBadge = u.premium
            ? '<span class="badge-premium">⭐ Premium</span>'
            : "";
          const routeText =
            (u.lines || []).join(", ") + (u.route ? " · " + u.route : "");
          const tags =
            Array.isArray(u.tags) && u.tags.length
              ? " · " + u.tags.join(", ")
              : "";
          return (
            '<a class="user-card" href="profil.html?user=' +
            encodeURIComponent(u.id) +
            '">' +
            "<h3>" +
            u.name +
            ", " +
            u.age +
            " " +
            premiumBadge +
            "</h3>" +
            '<p class="user-route">' +
            routeText +
            "</p>" +
            '<p class="user-bio">' +
            u.bio +
            "</p>" +
            '<p class="user-meta">En son: ' +
            u.lastSeen +
            tags +
            "</p>" +
            "</a>"
          );
        })
        .join("");

      usersSection.innerHTML = cards;
    }

    // Geri dön butonu
    backAll.addEventListener("click", function () {
      location.href = "hatlar.html";
    });
  </script>
</body>
</html>
